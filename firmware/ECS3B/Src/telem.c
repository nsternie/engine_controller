#include "telem.h"
#include "pack_telem_defines.h"

#define PACKET_SEP '\n'
#define FinishBlock(X) (*code_ptr = (X), code_ptr = stuffed++, code = 0x01)

void pack_telem(uint8_t *dst){
	*dst = TELEM_ITEM_0;
	*(dst+1) = TELEM_ITEM_1;
	*(dst+2) = TELEM_ITEM_2;
	*(dst+3) = TELEM_ITEM_3;
	*(dst+4) = TELEM_ITEM_4;
	*(dst+5) = TELEM_ITEM_5;
	*(dst+6) = TELEM_ITEM_6;
	*(dst+7) = TELEM_ITEM_7;
	*(dst+8) = TELEM_ITEM_8;
	*(dst+9) = TELEM_ITEM_9;
	*(dst+10) = TELEM_ITEM_10;
	*(dst+11) = TELEM_ITEM_11;
	*(dst+12) = TELEM_ITEM_12;
	*(dst+13) = TELEM_ITEM_13;
	*(dst+14) = TELEM_ITEM_14;
	*(dst+15) = TELEM_ITEM_15;
	*(dst+16) = TELEM_ITEM_16;
	*(dst+17) = TELEM_ITEM_17;
	*(dst+18) = TELEM_ITEM_18;
	*(dst+19) = TELEM_ITEM_19;
	*(dst+20) = TELEM_ITEM_20;
	*(dst+21) = TELEM_ITEM_21;
	*(dst+22) = TELEM_ITEM_22;
	*(dst+23) = TELEM_ITEM_23;
	*(dst+24) = TELEM_ITEM_24;
	*(dst+25) = TELEM_ITEM_25;
	*(dst+26) = TELEM_ITEM_26;
	*(dst+27) = TELEM_ITEM_27;
	*(dst+28) = TELEM_ITEM_28;
	*(dst+29) = TELEM_ITEM_29;
	*(dst+30) = TELEM_ITEM_30;
	*(dst+31) = TELEM_ITEM_31;
	*(dst+32) = TELEM_ITEM_32;
	*(dst+33) = TELEM_ITEM_33;
	*(dst+34) = TELEM_ITEM_34;
	*(dst+35) = TELEM_ITEM_35;
	*(dst+36) = TELEM_ITEM_36;
	*(dst+37) = TELEM_ITEM_37;
	*(dst+38) = TELEM_ITEM_38;
	*(dst+39) = TELEM_ITEM_39;
	*(dst+40) = TELEM_ITEM_40;
	*(dst+41) = TELEM_ITEM_41;
	*(dst+42) = TELEM_ITEM_42;
	*(dst+43) = TELEM_ITEM_43;
	*(dst+44) = TELEM_ITEM_44;
	*(dst+45) = TELEM_ITEM_45;
	*(dst+46) = TELEM_ITEM_46;
	*(dst+47) = TELEM_ITEM_47;
	*(dst+48) = TELEM_ITEM_48;
	*(dst+49) = TELEM_ITEM_49;
	*(dst+50) = TELEM_ITEM_50;
	*(dst+51) = TELEM_ITEM_51;
	*(dst+52) = TELEM_ITEM_52;
	*(dst+53) = TELEM_ITEM_53;
	*(dst+54) = TELEM_ITEM_54;
	*(dst+55) = TELEM_ITEM_55;
	*(dst+56) = TELEM_ITEM_56;
	*(dst+57) = TELEM_ITEM_57;
	*(dst+58) = TELEM_ITEM_58;
	*(dst+59) = TELEM_ITEM_59;
	*(dst+60) = TELEM_ITEM_60;
	*(dst+61) = TELEM_ITEM_61;
	*(dst+62) = TELEM_ITEM_62;
	*(dst+63) = TELEM_ITEM_63;
	*(dst+64) = TELEM_ITEM_64;
	*(dst+65) = TELEM_ITEM_65;
	*(dst+66) = TELEM_ITEM_66;
	*(dst+67) = TELEM_ITEM_67;
	*(dst+68) = TELEM_ITEM_68;
	*(dst+69) = TELEM_ITEM_69;
	*(dst+70) = TELEM_ITEM_70;
	*(dst+71) = TELEM_ITEM_71;
	*(dst+72) = TELEM_ITEM_72;
	*(dst+73) = TELEM_ITEM_73;
	*(dst+74) = TELEM_ITEM_74;
	*(dst+75) = TELEM_ITEM_75;
	*(dst+76) = TELEM_ITEM_76;
	*(dst+77) = TELEM_ITEM_77;
	*(dst+78) = TELEM_ITEM_78;
	*(dst+79) = TELEM_ITEM_79;
	*(dst+80) = TELEM_ITEM_80;
	*(dst+81) = TELEM_ITEM_81;
	*(dst+82) = TELEM_ITEM_82;
	*(dst+83) = TELEM_ITEM_83;
	*(dst+84) = TELEM_ITEM_84;
	*(dst+85) = TELEM_ITEM_85;
	*(dst+86) = TELEM_ITEM_86;
	*(dst+87) = TELEM_ITEM_87;
	*(dst+88) = TELEM_ITEM_88;
	*(dst+89) = TELEM_ITEM_89;
	*(dst+90) = TELEM_ITEM_90;
	*(dst+91) = TELEM_ITEM_91;
	*(dst+92) = TELEM_ITEM_92;
	*(dst+93) = TELEM_ITEM_93;
	*(dst+94) = TELEM_ITEM_94;
	*(dst+95) = TELEM_ITEM_95;
	*(dst+96) = TELEM_ITEM_96;
	*(dst+97) = TELEM_ITEM_97;
	*(dst+98) = TELEM_ITEM_98;
	*(dst+99) = TELEM_ITEM_99;
	*(dst+100) = TELEM_ITEM_100;
	*(dst+101) = TELEM_ITEM_101;
	*(dst+102) = TELEM_ITEM_102;
	*(dst+103) = TELEM_ITEM_103;
	*(dst+104) = TELEM_ITEM_104;
	*(dst+105) = TELEM_ITEM_105;
	*(dst+106) = TELEM_ITEM_106;
	*(dst+107) = TELEM_ITEM_107;
	*(dst+108) = TELEM_ITEM_108;
	*(dst+109) = TELEM_ITEM_109;
	*(dst+110) = TELEM_ITEM_110;
	*(dst+111) = TELEM_ITEM_111;
	*(dst+112) = TELEM_ITEM_112;
	*(dst+113) = TELEM_ITEM_113;
	*(dst+114) = TELEM_ITEM_114;
	*(dst+115) = TELEM_ITEM_115;
	*(dst+116) = TELEM_ITEM_116;
	*(dst+117) = TELEM_ITEM_117;
	*(dst+118) = TELEM_ITEM_118;
	*(dst+119) = TELEM_ITEM_119;
	*(dst+120) = TELEM_ITEM_120;
	*(dst+121) = TELEM_ITEM_121;
	*(dst+122) = TELEM_ITEM_122;
	*(dst+123) = TELEM_ITEM_123;
	*(dst+124) = TELEM_ITEM_124;
	*(dst+125) = TELEM_ITEM_125;
	*(dst+126) = TELEM_ITEM_126;
	*(dst+127) = TELEM_ITEM_127;
	*(dst+128) = TELEM_ITEM_128;
	*(dst+129) = TELEM_ITEM_129;
	*(dst+130) = TELEM_ITEM_130;
	*(dst+131) = TELEM_ITEM_131;
	*(dst+132) = TELEM_ITEM_132;
	*(dst+133) = TELEM_ITEM_133;
	*(dst+134) = TELEM_ITEM_134;
	*(dst+135) = TELEM_ITEM_135;
	*(dst+136) = TELEM_ITEM_136;
	*(dst+137) = TELEM_ITEM_137;
	*(dst+138) = TELEM_ITEM_138;
	*(dst+139) = TELEM_ITEM_139;
	*(dst+140) = TELEM_ITEM_140;
	*(dst+141) = TELEM_ITEM_141;
	*(dst+142) = TELEM_ITEM_142;
	*(dst+143) = TELEM_ITEM_143;
	*(dst+144) = TELEM_ITEM_144;
	*(dst+145) = TELEM_ITEM_145;
	*(dst+146) = TELEM_ITEM_146;
	*(dst+147) = TELEM_ITEM_147;
	*(dst+148) = TELEM_ITEM_148;
	*(dst+149) = TELEM_ITEM_149;
	*(dst+150) = TELEM_ITEM_150;
	*(dst+151) = TELEM_ITEM_151;
	*(dst+152) = TELEM_ITEM_152;
	*(dst+153) = TELEM_ITEM_153;
	*(dst+154) = TELEM_ITEM_154;
	*(dst+155) = TELEM_ITEM_155;
	*(dst+156) = TELEM_ITEM_156;
	*(dst+157) = TELEM_ITEM_157;
	*(dst+158) = TELEM_ITEM_158;
	*(dst+159) = TELEM_ITEM_159;
	*(dst+160) = TELEM_ITEM_160;
	*(dst+161) = TELEM_ITEM_161;
	*(dst+162) = TELEM_ITEM_162;
	*(dst+163) = TELEM_ITEM_163;
	*(dst+164) = TELEM_ITEM_164;
	*(dst+165) = TELEM_ITEM_165;
	*(dst+166) = TELEM_ITEM_166;
	*(dst+167) = TELEM_ITEM_167;
	*(dst+168) = TELEM_ITEM_168;
	*(dst+169) = TELEM_ITEM_169;
	*(dst+170) = TELEM_ITEM_170;
	*(dst+171) = TELEM_ITEM_171;
	*(dst+172) = TELEM_ITEM_172;
	*(dst+173) = TELEM_ITEM_173;
	*(dst+174) = TELEM_ITEM_174;
	*(dst+175) = TELEM_ITEM_175;
	*(dst+176) = TELEM_ITEM_176;
	*(dst+177) = TELEM_ITEM_177;
	*(dst+178) = TELEM_ITEM_178;
	*(dst+179) = TELEM_ITEM_179;
	*(dst+180) = TELEM_ITEM_180;
	*(dst+181) = TELEM_ITEM_181;
	*(dst+182) = TELEM_ITEM_182;
	*(dst+183) = TELEM_ITEM_183;
	*(dst+184) = TELEM_ITEM_184;
	*(dst+185) = TELEM_ITEM_185;
	*(dst+186) = TELEM_ITEM_186;
	*(dst+187) = TELEM_ITEM_187;
	*(dst+188) = TELEM_ITEM_188;
	*(dst+189) = TELEM_ITEM_189;
	*(dst+190) = TELEM_ITEM_190;
	*(dst+191) = TELEM_ITEM_191;
	*(dst+192) = TELEM_ITEM_192;
	*(dst+193) = TELEM_ITEM_193;
	*(dst+194) = TELEM_ITEM_194;
	*(dst+195) = TELEM_ITEM_195;
	*(dst+196) = TELEM_ITEM_196;
	*(dst+197) = TELEM_ITEM_197;
	*(dst+198) = TELEM_ITEM_198;
	*(dst+199) = TELEM_ITEM_199;
	*(dst+200) = TELEM_ITEM_200;
	*(dst+201) = TELEM_ITEM_201;
	*(dst+202) = TELEM_ITEM_202;
	*(dst+203) = TELEM_ITEM_203;
	*(dst+204) = TELEM_ITEM_204;
	*(dst+205) = TELEM_ITEM_205;
	*(dst+206) = TELEM_ITEM_206;
	*(dst+207) = TELEM_ITEM_207;
	*(dst+208) = TELEM_ITEM_208;
	*(dst+209) = TELEM_ITEM_209;
	*(dst+210) = TELEM_ITEM_210;
	*(dst+211) = TELEM_ITEM_211;
	*(dst+212) = TELEM_ITEM_212;
	*(dst+213) = TELEM_ITEM_213;
	*(dst+214) = TELEM_ITEM_214;
	*(dst+215) = TELEM_ITEM_215;
	*(dst+216) = TELEM_ITEM_216;
	*(dst+217) = TELEM_ITEM_217;
	*(dst+218) = TELEM_ITEM_218;
	*(dst+219) = TELEM_ITEM_219;
	*(dst+220) = TELEM_ITEM_220;
	*(dst+221) = TELEM_ITEM_221;
	*(dst+222) = TELEM_ITEM_222;
	*(dst+223) = TELEM_ITEM_223;
	*(dst+224) = TELEM_ITEM_224;
	*(dst+225) = TELEM_ITEM_225;
	*(dst+226) = TELEM_ITEM_226;
	*(dst+227) = TELEM_ITEM_227;
	*(dst+228) = TELEM_ITEM_228;
	*(dst+229) = TELEM_ITEM_229;
	*(dst+230) = TELEM_ITEM_230;
	*(dst+231) = TELEM_ITEM_231;
	*(dst+232) = TELEM_ITEM_232;
	*(dst+233) = TELEM_ITEM_233;
	*(dst+234) = TELEM_ITEM_234;
	*(dst+235) = TELEM_ITEM_235;
	*(dst+236) = TELEM_ITEM_236;
	*(dst+237) = TELEM_ITEM_237;
	*(dst+238) = TELEM_ITEM_238;
	*(dst+239) = TELEM_ITEM_239;
	*(dst+240) = TELEM_ITEM_240;
	*(dst+241) = TELEM_ITEM_241;
	*(dst+242) = TELEM_ITEM_242;
	*(dst+243) = TELEM_ITEM_243;
	*(dst+244) = TELEM_ITEM_244;
	*(dst+245) = TELEM_ITEM_245;
	*(dst+246) = TELEM_ITEM_246;
	*(dst+247) = TELEM_ITEM_247;
	*(dst+248) = TELEM_ITEM_248;
	*(dst+249) = TELEM_ITEM_249;
	*(dst+250) = TELEM_ITEM_250;
	*(dst+251) = TELEM_ITEM_251;
	*(dst+252) = TELEM_ITEM_252;
	*(dst+253) = TELEM_ITEM_253;

}

void stuff_telem(uint8_t *unstuffed, uint8_t *stuffed){
	const uint8_t *end = unstuffed + PACKET_SIZE;
	uint8_t *code_ptr = stuffed++;
	uint8_t code = 0x01;

	while (unstuffed < end){
		if (*unstuffed == PACKET_SEP)
			FinishBlock(code);
		else{
			*stuffed++ = *unstuffed;
			if (++code == 0xFF){
				FinishBlock(code);
			}
		}
		unstuffed++;
	}
	*stuffed = '\n';

	FinishBlock(code);
}
